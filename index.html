<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>청주시 무장애 지도</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', 'Apple SD Gothic Neo', 'Malgun Gothic', Arial, sans-serif;
      }
      .app {
        display: flex;
        height: 100%;
        width: 100%;
        overflow: hidden;
      }
      .sidebar {
        display: flex;
        flex-direction: column;
        background: #fff;
        border-right: 1px solid #e5e7eb;
      }
      .sidebar.left { width: 320px; min-width: 260px; }
      .sidebar.right { width: 380px; min-width: 300px; border-right: none; border-left: 1px solid #e5e7eb; }

      .sidebar-header {
        padding: 12px 14px;
        border-bottom: 1px solid #e5e7eb;
        background: #f9fafb;
        font-weight: 600;
      }
      .tabs { display: flex; gap: 8px; }
      .tab {
        appearance: none;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 13px;
        cursor: pointer;
      }
      .tab.active { background: #eef2ff; border-color: #c7d2fe; }
      .sidebar-title { margin-top: 8px; font-weight: 700; }
      .list {
        overflow: auto;
        flex: 1;
      }
      .list-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: 12px 14px;
        border-bottom: 1px solid #f1f5f9;
        cursor: pointer;
      }
      .list-item:hover { background: #f8fafc; }
      .list-item.active { background: #eef2ff; }
      .list-title { font-weight: 600; font-size: 14px; color: #111827; }
      .list-sub { font-size: 12px; color: #4b5563; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

      #map { flex: 1; height: 100%; }

      .detail {
        overflow: auto;
        flex: 1;
      }
      .detail-content { padding: 14px; }
      .detail-title { font-size: 18px; font-weight: 700; margin: 0 0 8px; }
      .detail-row { margin: 8px 0; font-size: 14px; color: #111827; }
      .detail-label { display: inline-block; min-width: 110px; color: #6b7280; }
      .muted { color: #6b7280; }

      @media (max-width: 1024px) {
        .sidebar.left { width: 280px; }
        .sidebar.right { display: none; }
      }
    </style>
  </head>
  <body>
    <div class="app">
        <aside class="sidebar left" aria-label="목록">
          <div class="sidebar-header">
            <div class="tabs" role="tablist" aria-label="데이터셋 선택">
              <button id="tabTour" class="tab active" role="tab" aria-selected="true">관광지</button>
              <button id="tabFood" class="tab" role="tab" aria-selected="false">식당/카페</button>
            </div>
            <div id="sidebarTitle" class="sidebar-title">관광지 목록</div>
          </div>
          <div id="placeList" class="list" role="list"></div>
        </aside>
        <div id="map" role="region" aria-label="지도"></div>

      <aside class="sidebar right" aria-label="관광지 상세">
        <div class="sidebar-header">상세 정보</div>
        <div id="detail" class="detail">
          <div class="detail-content muted">왼쪽 목록이나 지도 마커를 클릭하면 상세 정보가 여기에 표시됩니다.</div>
        </div>
      </aside>
    </div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <script>
// 설정: 데이터셋 (파일 경로 및 마커 색상)
const DATASETS = {
    tour: { url: 'data.csv', title: '관광지 목록', color: '#2563eb' },
    // 식당/카페: '카페/식당' 칼럼값으로 색상 분기 (카페 진한 보라, 식당 연보라)
    food: { url: 'data1.csv', title: '식당/카페 목록', colorCafe: '#8b5cf6', colorRestaurant: '#c4b5fd' },
  };

      // CSV 헤더(한글)를 상수화
      const COL = {
        name: 'a',
        wheelchair: 'b',
        toilet: 'c',
        phone: 'd',
        address: 'e',
        desc: 'f',
        lat: 'g',
        lng: 'h',
      };

       // 지도 초기화 (청주 대략 중심; 이후 데이터로 bounds fit)
      const map = L.map('map', { zoomControl: true }).setView([36.6439, 127.4886], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap 기여자'
      }).addTo(map);

      const tourIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize:     [25, 41],
        iconAnchor:   [12, 41],
        popupAnchor:  [1, -34],
        shadowSize:   [41, 41],
      });

      const cafeIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize:     [25, 41],
        iconAnchor:   [12, 41],
        popupAnchor:  [1, -34],
        shadowSize:   [41, 41],
      });

      const restaurantIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-gold.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize:     [25, 41],
        iconAnchor:   [12, 41],
        popupAnchor:  [1, -34],
        shadowSize:   [41, 41],
      });

const markers = [];
let loadedTour = false;
let loadedFood = false;
const listEl = document.getElementById('placeList');
const detailEl = document.getElementById('detail');
const sidebarTitleEl = document.getElementById('sidebarTitle');
const tabTourEl = document.getElementById('tabTour');
const tabFoodEl = document.getElementById('tabFood');
let currentType = 'tour';
let activeId = null;

      function createListItem(place, id) {
        const item = document.createElement('div');         item.className = 'list-item';
        item.setAttribute('role', 'listitem');
        item.dataset.id = id;

        const title = document.createElement('div');
        title.className = 'list-title';
        title.textContent = place[COL.name] || '(이름 없음)';

        const sub = document.createElement('div');
        sub.className = 'list-sub';
        const wc = place[COL.wheelchair] ? `휠체어: ${place[COL.wheelchair]}` : '';
        const toilet = place[COL.toilet] ? `화장실: ${place[COL.toilet]}` : '';
        const addr = place[COL.address] || '';
        sub.textContent = [wc, toilet, addr].filter(Boolean).join(' · ');

        item.appendChild(title);
        item.appendChild(sub);
        item.addEventListener('click', () => selectPlace(id, true));
        return item;
      }

      function renderListForCurrentType() {
        listEl.innerHTML = '';
        markers.forEach((m, id) => {
          if (!m || m.type !== currentType) return;
          const item = createListItem(m.place, id);
          listEl.appendChild(item);
        });
      }

      function renderDetail(place) {
        const name = place[COL.name] || '';
        const wheelchair = place[COL.wheelchair] || '';
        const toilet = place[COL.toilet] || '';
        const phone = place[COL.phone] || '';
        const address = place[COL.address] || '';
        const desc = place[COL.desc] || '';

        detailEl.innerHTML = `
          <div class="detail-content">
            <h2 class="detail-title">${escapeHtml(name)}</h2>
            <div class="detail-row"><span class="detail-label">휠체어 이용</span>${escapeHtml(wheelchair)}</div>
            <div class="detail-row"><span class="detail-label">장애인 화장실</span>${escapeHtml(toilet)}</div>
            <div class="detail-row"><span class="detail-label">연락처</span>${escapeHtml(phone)}</div>
            <div class="detail-row"><span class="detail-label">주소</span>${escapeHtml(address)}</div>
            <div class="detail-row"><span class="detail-label">설명</span>${escapeHtml(desc)}</div>
          </div>
        `;
      }

      function escapeHtml(str) {
        return String(str || '')
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#039;');
      } 
      function selectPlace(id, fromList = false) {
        const m = markers[id];
        if (!m) return;

        // 목록 하이라이트
        if (activeId !== null) {
          const prev = listEl.querySelector(`.list-item[data-id="${activeId}"]`);
          if (prev) prev.classList.remove('active');
        }
        const cur = listEl.querySelector(`.list-item[data-id="${id}"]`);
        if (cur) {
          cur.classList.add('active');
          cur.scrollIntoView({ block: 'nearest' });
        }
        activeId = id;

        // 상세 정보 렌더
        renderDetail(m.place);

        // 지도 이동 및 팝업
        const latlng = m.marker.getLatLng();
        map.setView(latlng, Math.max(map.getZoom(), 15), { animate: true });
        m.marker.openPopup();
      }

    function addMarker(place, id) {
        const lat = parseFloat(place[COL.lat]);
        const lng = parseFloat(place[COL.lng]);
        if (Number.isNaN(lat) || Number.isNaN(lng)) return null;

        const popupHtml = `
          <div>
            <div style="font-weight:700;margin-bottom:4px;">${escapeHtml(place[COL.name] || '')}</div>
            <div class="muted" style="font-size:12px;">${escapeHtml(place[COL.address] || '')}</div>
            <div style="margin-top:6px;font-size:12px;">
              휠체어: ${escapeHtml(place[COL.wheelchair] || '')} · 화장실: ${escapeHtml(place[COL.toilet] || '')}
            </div>
          </div>
        `;

      let icon = tourIcon;
      const typeField = place['i'];
      if (typeField !== undefined && typeField !== null) {
        const t = typeField.toString().trim();
        if (t.includes('식당')) icon = restaurantIcon;
        else icon = cafeIcon;
      }

      const marker = L.marker([lat, lng], { icon });
      marker.bindPopup(popupHtml);
      marker.addTo(map);
      marker.on('click', () => selectPlace(id));

      return marker;
      }

function clearAll() {
  listEl.innerHTML = '';
  detailEl.innerHTML = '<div class="detail-content muted">왼쪽 목록이나 지도 마커를 클릭하면 상세 정보가 여기에 표시됩니다.</div>';
  activeId = null;
}

        function loadCSV() {
          sidebarTitleEl.textContent = DATASETS[currentType].title;
          const url = DATASETS[currentType].url;
          Papa.parse(url, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: (res) => {
            const data = res.data || [];
            const bounds = L.latLngBounds();

              data.forEach((row) => {
              const id = markers.length;
              const marker = addMarker(row, id);
              if (marker) {
                markers[id] = { marker, place: row, type: currentType };
                bounds.extend(marker.getLatLng());
              }
            });

            if (bounds.isValid()) {
              map.fitBounds(bounds.pad(0.08));
            }

            if (currentType === 'tour') loadedTour = true;
            if (currentType === 'food') loadedFood = true;

            renderListForCurrentType();
          },
            error: (err) => {
            console.error('CSV 로드 실패:', err);
            detailEl.innerHTML = '<div class="detail-content">데이터 로드를 실패했습니다. 경로를 확인해 주세요.</div>';
          }
        });
      }

      function setActiveTab(type) {
        currentType = type;
        tabTourEl.classList.toggle('active', type === 'tour');
        tabTourEl.setAttribute('aria-selected', String(type === 'tour'));
        tabFoodEl.classList.toggle('active', type === 'food');
        tabFoodEl.setAttribute('aria-selected', String(type === 'food'));
      }

      function loadTourPlaces() {
        currentType = 'tour';
        setActiveTab('tour');
        clearAll();
        loadCSV();
      }

      function loadFoodPlaces() {
        currentType = 'food';
        setActiveTab('food');
        clearAll();
        loadCSV();
      }

      tabTourEl.addEventListener('click', () => {
        if (currentType !== 'tour') {
          loadTourPlaces();
        }
      });
      tabFoodEl.addEventListener('click', () => {
        if (currentType !== 'food') {
          loadFoodPlaces();
        }
      });

loadTourPlaces();
    </script>
  </body>
</html>
